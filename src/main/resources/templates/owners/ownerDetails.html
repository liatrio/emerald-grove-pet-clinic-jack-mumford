<!DOCTYPE html>

<html xmlns:th="https://www.thymeleaf.org" th:replace="~{fragments/layout :: layout (~{::body},'owners')}">

<body>

  <h2 th:text="#{ownerInformation}">Owner Information</h2>

  <div th:if="${message}" class="alert alert-success" id="success-message">
    <span th:text="${message}"></span>
  </div>

  <div th:if="${error}" class="alert alert-danger" id="error-message">
    <span th:text="${error}"></span>
  </div>

  <table class="table table-striped liatrio-table" th:object="${owner}">
    <tr>
      <th th:text="#{name}">Name</th>
      <td><b th:text="*{firstName + ' ' + lastName}"></b></td>
    </tr>
    <tr>
      <th th:text="#{address}">Address</th>
      <td th:text="*{address}"></td>
    </tr>
    <tr>
      <th th:text="#{city}">City</th>
      <td th:text="*{city}"></td>
    </tr>
    <tr>
      <th th:text="#{telephone}">Telephone</th>
      <td th:text="*{telephone}"></td>
    </tr>
  </table>

  <a th:href="@{__${owner.id}__/edit(lang=${#locale.language})}" class="btn btn-primary" th:text="#{editOwner}">Edit
    Owner</a>
  <a th:href="@{__${owner.id}__/pets/new(lang=${#locale.language})}" class="btn btn-primary" th:text="#{addNewPet}">Add
    New Pet</a>

  <br />
  <br />
  <br />
  <h2 th:text="#{petsAndVisits}">Pets and Visits</h2>

  <table class="table table-striped liatrio-table">

    <tr th:each="pet : ${owner.pets}">
      <td valign="top">
        <dl class="dl-horizontal">
          <dt th:text="#{name}">Name</dt>
          <dd th:text="${pet.name}"></dd>
          <dt th:text="#{birthDate}">Birth Date</dt>
          <dd th:text="${#temporals.format(pet.birthDate, 'yyyy-MM-dd')}"></dd>
          <dt th:text="#{type}">Type</dt>
          <dd th:text="${pet.type}"></dd>
        </dl>
      </td>
      <td valign="top">
        <table class="table-condensed liatrio-table">
          <thead>
            <tr>
              <th th:text="#{visitDate}">Visit Date</th>
              <th th:text="#{description}">Description</th>
            </tr>
          </thead>
          <tr th:each="visit : ${pet.visits}">
            <td th:text="${#temporals.format(visit.date, 'yyyy-MM-dd')}"></td>
            <td th:text="${visit?.description}"></td>
          </tr>
          <tr>
            <td><a th:href="@{__${owner.id}__/pets/__${pet.id}__/edit(lang=${#locale.language})}" th:text="#{editPet}">Edit Pet</a></td>
            <td><a th:href="@{__${owner.id}__/pets/__${pet.id}__/visits/new(lang=${#locale.language})}" th:text="#{addVisit}">Add Visit</a></td>
            <td>
              <button type="button" class="btn btn-danger btn-sm" 
                      data-bs-toggle="modal" 
                      data-bs-target="#deletePetModal"
                      th:attr="data-pet-id=${pet.id}, data-pet-name=${pet.name}, data-visit-count=${#lists.size(pet.visits)}"
                      th:text="#{deletePet}">
                Delete Pet
              </button>
            </td>
          </tr>
        </table>
      </td>
    </tr>

  </table>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deletePetModal" tabindex="-1" aria-labelledby="deletePetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletePetModalLabel" th:text="#{deletePet.confirm}">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p th:text="#{deletePet.confirmation}">Are you sure you want to delete this pet? All associated visits will also be deleted.</p>
          <p><strong id="modalPetName"></strong></p>
          <p id="modalVisitCount"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{cancel}">Cancel</button>
          <form id="deletePetForm" method="post" style="display: inline;">
            <button type="submit" class="btn btn-danger" th:text="#{deletePet}">Delete Pet</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Function to hide the success and error messages after 3 seconds
    function hideMessages() {
      setTimeout(function () {
        var successMsg = document.getElementById("success-message");
        var errorMsg = document.getElementById("error-message");
        if (successMsg) {
          successMsg.style.display = "none";
        }
        if (errorMsg) {
          errorMsg.style.display = "none";
        }
      }, 3000); // 3000 milliseconds (3 seconds)
    }

    // Call the function to hide messages
    hideMessages();

    // Populate modal with pet details
    var deletePetModal = document.getElementById('deletePetModal');
    if (deletePetModal) {
      deletePetModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var petId = button.getAttribute('data-pet-id');
        var petName = button.getAttribute('data-pet-name');
        var visitCount = button.getAttribute('data-visit-count');
        
        var modalPetName = document.getElementById('modalPetName');
        var modalVisitCount = document.getElementById('modalVisitCount');
        var deletePetForm = document.getElementById('deletePetForm');
        
        modalPetName.textContent = petName;
        modalVisitCount.textContent = 'This pet has ' + visitCount + ' visit(s) recorded.';
        
        // Set the form action to the delete endpoint
        var ownerId = window.location.pathname.split('/')[2];
        deletePetForm.action = '/owners/' + ownerId + '/pets/' + petId + '/delete';
      });
    }
  </script>

</body>


</html>
